# NetGuardian AI - User Guide

This guide explains how to use NetGuardian AI's features for network security monitoring.

## Getting Started

### First Login

1. Navigate to the NetGuardian web interface (default: http://localhost:5173)
2. Log in with the admin credentials (check deployment logs for initial password)
3. **Important:** Change your password immediately after first login

### Single Sign-On (Authentik)

If your organization has configured Authentik SSO:

1. Navigate to the NetGuardian login page
2. Click "Sign in with Authentik" below the login form
3. You'll be redirected to your Authentik instance
4. Log in with your organization credentials
5. After authentication, you'll be redirected back to NetGuardian

**SSO Users:**
- Your account may be created automatically on first login (if enabled)
- Alternatively, your admin may pre-create your account with a specific role
- If your account was pre-created, it links to your Authentik identity on first SSO login
- Your role may be assigned based on Authentik group membership or set by admin
- You can still use local authentication if needed

### User Roles

NetGuardian supports three user roles:

| Role | Permissions |
|------|-------------|
| **Admin** | Full access: user management, system config, all operations |
| **Operator** | Operational access: quarantine devices, acknowledge alerts, manage playbooks |
| **Viewer** | Read-only access: view dashboard, devices, events, alerts |

## Dashboard

The dashboard provides an overview of your network security status:

- **Device Count:** Total devices discovered on your network
- **Active Alerts:** Alerts requiring attention
- **Events Today:** Total events processed in the last 24 hours
- **Anomalies:** Detected behavioral anomalies

Click any stat card to navigate to the detailed view.

## Devices

### Device List

The Devices page shows all discovered network devices with:
- Hostname and IP address
- MAC address
- Device status (online, offline, quarantined)
- First and last seen timestamps

### Device Details

Click a device to view:
- **Overview:** Basic device information
- **Events:** Recent events from this device
- **Baselines:** Behavioral baselines (DNS, traffic, connections)
- **Anomalies:** Detected anomalies for this device
- **Audit Log:** Actions taken on this device

### Device Actions

**Quarantine a Device:**
1. Open device details
2. Click "Quarantine" button
3. Provide a reason (optional)
4. Confirm the action

Quarantining blocks the device at:
- DNS level (via AdGuard Home if configured)
- Network level (via router integration if configured)

**Release a Device:**
1. Open quarantined device
2. Click "Release" button
3. Confirm the action

## Events

### Event Feed

View all normalized events from configured log sources:
- Filter by event type (DNS, firewall, auth, http, system)
- Filter by severity (debug, info, warning, error, critical)
- Filter by time range
- Search by IP, domain, or message content

### Event Types

| Type | Description |
|------|-------------|
| DNS | DNS queries and responses |
| Firewall | Firewall allow/block actions |
| Auth | Authentication events (including Authentik SSO events) |
| HTTP | Web request logs |
| System | System and application logs |
| LLM | AI/LLM interaction events |
| Endpoint | Endpoint agent events (processes, connections) |
| Flow | Network flow data (NetFlow/sFlow) |
| HTTP | Web server access/error logs (e.g., from Loki) |

## Alerts

### Alert Management

Alerts are generated by:
- Anomaly detection system
- Detection rules
- Playbook triggers
- Manual creation

**Alert Severities:**
- **Info:** Informational, no action required
- **Low:** Minor issue, investigate when convenient
- **Medium:** Moderate concern, investigate soon
- **High:** Significant threat, investigate immediately
- **Critical:** Severe threat, immediate action required

### Alert Actions

**Acknowledge Alert:**
1. Open alert details
2. Click "Acknowledge"
3. Add notes (optional)

**Analyze with AI:**
1. Open alert details
2. Click "Analyze"
3. View AI-generated analysis including:
   - Severity assessment
   - Potential threat indicators
   - Recommended actions

## Anomaly Detection

### How It Works

NetGuardian learns normal behavior patterns for each device:
- DNS query patterns (domains, volume, blocked ratio)
- Traffic patterns (connections, ports, data volume)
- Connection patterns (destinations, protocols)

Anomalies are detected when behavior deviates significantly from baselines.

### Anomaly Types

| Type | Description |
|------|-------------|
| New Domain | Device queried a never-before-seen domain |
| Volume Spike | Unusual increase in DNS queries or traffic |
| Blocked Spike | Sudden increase in blocked requests |
| New Connection | Connection to new IP/port combination |
| Pattern Change | Significant change in behavior patterns |

### Managing Anomalies

**Review Anomaly:**
1. Open anomaly details
2. Review device context and baseline comparison
3. Determine if legitimate or suspicious

**Mark Anomaly Status:**
- **Acknowledged:** Under investigation
- **False Positive:** Not a real threat
- **Resolved:** Threat mitigated

### Recalculating Baselines

After resolving false positives or expected behavior changes:
1. Open device details
2. Go to Baselines tab
3. Click "Recalculate Baseline"

## AI Chat

### Natural Language Queries

Use the AI Chat to ask questions about your network:

**Example Queries:**
- "Show me devices with unusual DNS activity"
- "What alerts were generated today?"
- "Summarize network activity for the last hour"
- "Which device has the most blocked requests?"

### Model Selection

Choose the model based on your needs:
- **Fast (Haiku):** Quick responses for simple queries
- **Balanced (Sonnet):** Good balance of speed and depth
- **Deep (Sonnet):** Detailed analysis for complex questions

## Quarantine Management

### Quarantine Page

The Quarantine page shows:
- Currently quarantined devices
- Integration status (AdGuard, router)
- Recent quarantine/release activity

### Sync Quarantine

If integrations get out of sync:
1. Go to Quarantine page
2. Click "Sync Quarantine"
3. This reconciles device status with external systems

## Playbooks

### What Are Playbooks?

Playbooks are automated response rules that trigger actions based on events:

**Trigger Types:**
- Anomaly detected
- Alert created
- New device discovered
- Device status changed
- Manual trigger

**Action Types:**
- Quarantine device
- Release device
- Create alert
- Tag device
- Send notification (webhook)
- Log event

### Creating a Playbook

1. Go to Settings > Playbooks
2. Click "Create Playbook"
3. Configure:
   - Name and description
   - Trigger conditions
   - Actions to execute
   - Rate limits (cooldown, max executions/hour)
4. Save and activate

### Example Playbook

**Auto-quarantine high-risk anomalies:**
```
Trigger: Anomaly detected with severity >= high
Actions:
  1. Quarantine device
  2. Create alert with severity: critical
  3. Send webhook notification
Cooldown: 300 seconds
Max per hour: 10
```

## Log Sources

### Configuring Sources

Admin users can configure log sources:

1. Go to Settings > Log Sources
2. Click "Add Source"
3. Select source type:
   - **API Pull:** Fetch from REST APIs (AdGuard, UniFi, etc.)
   - **File Watch:** Monitor log files
   - **API Push:** Receive events via webhook
   - **UDP Listen:** Receive syslog, NetFlow, or sFlow via UDP

### API Pull Configuration

```
URL: http://adguard.local:3000
Endpoint: /control/querylog
Auth Type: Basic
Username: admin
Password: ******
Poll Interval: 5 seconds
```

### API Push Configuration

After creating an API Push source, use the generated API key:

```bash
curl -X POST http://netguardian:8000/api/v1/logs/ingest \
  -H "X-Source-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{"events": [{"raw_message": "event data"}]}'
```

### Endpoint Agent Sources

To receive data from endpoint agents:

1. Create an **API Push** source with **endpoint** parser
2. Copy the generated API key
3. Configure the endpoint agent with the API key
4. Agent sends process and network events automatically

### NetFlow/sFlow Sources

To receive network flow data:

1. Create a **UDP Listen** source
2. Select parser type: **netflow** or **sflow**
3. Configure the UDP port (default: 2055 for NetFlow, 6343 for sFlow)
4. Configure your router/switch to send flow data to NetGuardian

### Syslog Sources (NAS, Routers, Switches)

To receive syslog from devices like Synology NAS, routers, or switches:

1. Create a **UDP Listen** source
2. Select parser type: **syslog**
3. Configure the UDP port (default: 5514 to avoid privileged port 514)
4. **Important:** Expose the UDP port in your Docker configuration:
   ```yaml
   collector:
     ports:
       - "5514:5514/udp"
   ```
5. Configure your device to send syslog to NetGuardian's IP and port

**Synology NAS Configuration:**
1. Open DSM > Log Center > Log Sending
2. Click Create and configure:
   - Server: NetGuardian server IP
   - Port: 5514
   - Protocol: UDP
   - Format: BSD (RFC 3164) or IETF (RFC 5424)
3. Select which logs to send (System, Connection, File Transfer, etc.)

**Supported Syslog Formats:**
- RFC 3164 (BSD syslog)
- RFC 5424 (IETF syslog with structured data)
- Simple syslog without PRI

### Grafana Loki Sources

To collect logs from Grafana Loki:

1. Create an **API Pull** source
2. Select parser type: **loki**
3. Configure:
   - URL: Your Loki server URL (e.g., `http://loki:3100`)
   - Endpoint: `/loki/api/v1/query_range`
   - Query: LogQL query (e.g., `{job=~".+"}` for all jobs)
   - Poll Interval: How often to fetch logs

**Loki Parser Features:**
- Supports both query API responses and push API format
- Auto-detects severity from `level` label or log content
- Maps job names to event types (nginx→HTTP, sshd→AUTH, etc.)
- Extracts IP addresses from log lines
- Preserves all Loki labels in parsed fields

**Example Configuration:**
```
URL: http://loki.monitoring.svc:3100
Endpoint: /loki/api/v1/query_range
Query: {namespace="production"}
Auth Type: None (or Bearer for secured Loki)
Poll Interval: 60 seconds
```

### Authentik Event Sources

Monitor authentication events from your Authentik identity provider:

1. Create an **API Pull** source
2. Select parser type: **authentik**
3. Configure:
   - URL: Your Authentik server URL
   - Endpoint: `/api/v3/events/`
   - Auth Type: Bearer token (create an API token in Authentik)
   - Poll Interval: How often to fetch events

**Authentik Parser Features:**
- Parses login, logout, and authorization events
- Detects failed logins and suspicious requests
- Tracks impersonation events
- Maps event actions to severity levels
- Extracts client IP and geo information

**Example Configuration:**
```
URL: https://auth.example.com
Endpoint: /api/v3/events/
Auth Type: Bearer
API Key: your-authentik-api-token
Poll Interval: 60 seconds
```

**Detected Event Types:**
| Action | Severity | Security Flag |
|--------|----------|---------------|
| login | Info | No |
| login_failed | Warning | Yes |
| logout | Info | No |
| authorize_application | Info | No |
| impersonation_started | Warning | Yes |
| suspicious_request | Error | Yes |
| policy_exception | Warning | No |

## User Management

### Managing Users (Admin Only)

1. Go to Settings > Users
2. View all users and their roles
3. Actions available:
   - Create new user
   - Edit user role/status
   - Reset password
   - Deactivate user

### Password Requirements

Passwords must:
- Be at least 12 characters
- Include uppercase and lowercase letters
- Include at least one digit
- Include at least one special character
- Not be a common password
- Not contain 3+ consecutive identical characters

## Semantic Log Analysis

### Overview

Semantic Log Analysis uses AI to identify unusual log messages that differ from normal patterns. Unlike volume-based anomaly detection, this feature analyzes the *content* of logs to find security-relevant irregularities.

**How It Works:**
1. **Pattern Learning:** Logs are normalized into templates (replacing IPs, timestamps, UUIDs with placeholders)
2. **Rarity Detection:** Patterns seen fewer than the threshold count are flagged as irregular
3. **LLM Analysis:** Irregular logs are batched and sent to an LLM (Claude or Ollama) for security review
4. **Rule Suggestions:** The LLM can suggest detection rules based on findings

### Log Patterns Page

Access via **Log Patterns** in the sidebar. This page shows learned patterns:

| Column | Description |
|--------|-------------|
| Pattern | Normalized log template with placeholders |
| Source | Log source this pattern belongs to |
| Count | Number of times this pattern was seen |
| First Seen | When the pattern was first observed |
| Last Seen | Most recent occurrence |
| Status | Normal or Ignored |

**Managing Patterns:**
- **Ignore Pattern:** Click the ignore toggle to exclude a pattern from irregularity detection. Use this for known benign patterns that appear rarely.
- **Filter by Source:** Use the source dropdown to view patterns from specific log sources.
- **Search:** Find patterns containing specific text.

### Semantic Review Page

Access via **Semantic Review** in the sidebar. This shows logs flagged as irregular:

| Column | Description |
|--------|-------------|
| Timestamp | When the log was received |
| Source | Log source |
| Message | Original log message |
| Reason | Why it was flagged as irregular |
| Severity | LLM-assigned severity (0.0-1.0) |
| Status | Pending review, Reviewed |

**Reviewing Irregular Logs:**
1. Click a row to expand the full log details
2. Review the LLM analysis explaining why it's concerning
3. Click **Mark Reviewed** to acknowledge the log
4. If it's a false positive, consider ignoring the pattern

**Filters:**
- **Source:** Filter by log source
- **Severity:** Show only high-severity items (≥0.7)
- **Status:** Show pending or reviewed items
- **Date Range:** Filter by time period

### Suggested Rules Page

Access via **Suggested Rules** in the sidebar. The LLM can suggest detection rules based on its analysis:

**Pending Tab:**
- Shows rules awaiting your review
- Each rule displays:
  - **Name:** Descriptive rule name
  - **Description:** What the rule detects
  - **Reason:** Why the LLM suggested it
  - **Benefit:** How it improves security
  - **Rule Type:** Pattern match, threshold, or sequence

**Actions:**
- **Approve:** Accept the rule and optionally enable it immediately
- **Reject:** Decline with a reason (prevents re-suggestion)
- **Edit:** Modify rule config before approving

**History Tab:**
- View previously approved/rejected rules
- Filter by status, source, or date

### Configuration

Configure Semantic Analysis per log source in **Settings > Log Sources**:

1. Select a log source
2. Enable **Semantic Analysis**
3. Configure:
   - **LLM Provider:** Claude (cloud) or Ollama (local)
   - **Ollama Model:** If using Ollama, select the model (llama3.2, mistral, etc.)
   - **Rarity Threshold:** Patterns seen fewer than N times are irregular (default: 3)
   - **Batch Size:** Maximum logs per LLM analysis batch (default: 50)
   - **Batch Interval:** Minutes between analysis runs (default: 60)

### Triggering Manual Analysis

To run analysis immediately:
1. Go to **Settings > Log Sources**
2. Select the source
3. Click **Trigger Analysis**

Or use the API:
```bash
POST /api/v1/semantic/runs/{source_id}/trigger
```

## Ollama Monitoring

### LLM Security Monitoring

If you run a local Ollama instance, NetGuardian can monitor for:
- Prompt injection attempts
- Jailbreak attempts
- Data exfiltration attempts

### Enabling Ollama Monitoring

1. Configure Ollama settings in environment:
   ```
   OLLAMA_ENABLED=true
   OLLAMA_URL=http://localhost:11434
   ```

2. View status at Settings > Ollama Monitoring

### Threat Detection

Detected threats appear in the events feed with:
- Risk score (0-100)
- Detected patterns
- Recommended actions

## Best Practices

### Security

1. **Change default credentials** immediately after deployment
2. **Use strong passwords** meeting complexity requirements
3. **Review audit logs** regularly for unauthorized access
4. **Keep integrations updated** with current credentials

### Monitoring

1. **Review alerts daily** - don't let them pile up
2. **Investigate anomalies** - understand why they occurred
3. **Tune baselines** after legitimate behavior changes
4. **Use playbooks** to automate common responses

### Maintenance

1. **Monitor disk usage** - TimescaleDB can grow quickly
2. **Review retention policies** - configure data retention
3. **Update regularly** - keep the application current
4. **Backup database** - regular backups are essential

## Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| `?` | Show help |
| `/` | Focus search |
| `g d` | Go to Dashboard |
| `g v` | Go to Devices |
| `g e` | Go to Events |
| `g a` | Go to Alerts |

## Troubleshooting

### Can't Log In

1. Check caps lock is off
2. Try username in lowercase
3. Request password reset from admin
4. Check rate limiting (5 attempts per minute)

### No Events Appearing

1. Check log source is enabled
2. Verify log source connectivity (test connection)
3. Check collector logs for errors
4. Verify file permissions for file-based sources

### Alerts Not Generating

1. Check anomaly detection is running
2. Verify device baselines are established
3. Review detection rule configuration
4. Check playbook is active

### AI Chat Not Working

1. Verify ANTHROPIC_API_KEY is set
2. Check LLM_ENABLED is true
3. Review backend logs for API errors
4. Check API key has sufficient credits

## Getting Help

- **Documentation:** Check the `/docs` directory
- **API Reference:** Visit `/docs` on your backend URL
- **GitHub Issues:** Report bugs and request features
- **Logs:** Check container logs for error details
